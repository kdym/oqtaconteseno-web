# Place all the behaviors and hooks related to the matching controller here.
# All this logic will automatically be available in application.js.
# You can use CoffeeScript in this file: http://coffeescript.org/

newEventWindow = null
map = null

if navigator.geolocation
  navigator.geolocation.getCurrentPosition((position) ->
    myPosition = {lat: position.coords.latitude, lng: position.coords.longitude}

    map = new google.maps.Map(document.getElementById('map'),
      zoom: 17
      center: myPosition
      mapTypeControl: false
      fullscreenControl: false
      disableDoubleClickZoom: true
      clickableIcons: false
    )

    #    myPositionMarker = new (google.maps.Marker)(
    #      map: map
    #      position: myPosition
    #      icon: '<%= asset_path 'position_marker.png' %>                             '
    #    )

    addYourLocationButton map

    newEventWindow = new (google.maps.InfoWindow)(
      content: $('#add-event-info-window-template').html()
    )

    map.addListener 'dblclick', (event) ->
      callNewEventWindow event.latLng
  )

$('#add-event-form').validate
  ignore: []
  rules:
    'event[nome]': 'required'
    'event[tipo]':
      min: 1
    'event[data_inicio]': 'required'
    'event[data_fim]':
      required: true
      validPeriod: ['event[data_inicio]', 'event[data_fim]']
  messages:
    'event[tipo]':
      min: '<%= I18n.t('activerecord.errors.messages.required') %>'
  errorPlacement: (error, element) ->
    switch element.attr('name')
      when 'event[tipo]'
        error.appendTo '#tipo-error-label'
      else
        error.insertAfter element

$('#add-event-form').ajaxForm
  dataType: 'json'
  beforeSubmit: ->
    $('#add-event-modal .loading-div').fadeIn()
  success: ->
    $('#add-event-modal').modal 'hide'
    $('#add-event-form').trigger 'reset'
    $('#tipo').ddslick 'select', {index: 0}

    $('#add-event-modal .loading-div').fadeOut()

    findEvents()

$('#add-event-button').click ->
  $('#add-event-form').submit()

  false

callNewEventWindow = (position) ->
  newEventWindow.close()
  newEventWindow.setPosition(position)
  newEventWindow.open(map)

  $('#event_latitude').val(position.lat)
  $('#event_longitude').val(position.lng)

  $('#add-new-event-link').click ->
    $('#add-event-modal').modal 'show'

    false

addYourLocationButton = (map) ->
  controlDiv = document.createElement('div')
  firstChild = document.createElement('button')
  firstChild.style.backgroundColor = '#fff'
  firstChild.style.border = 'none'
  firstChild.style.outline = 'none'
  firstChild.style.width = '28px'
  firstChild.style.height = '28px'
  firstChild.style.borderRadius = '2px'
  firstChild.style.boxShadow = '0 1px 4px rgba(0,0,0,0.3)'
  firstChild.style.cursor = 'pointer'
  firstChild.style.marginRight = '10px'
  firstChild.style.padding = '0px'
  firstChild.title = 'Your Location'
  controlDiv.appendChild firstChild
  secondChild = document.createElement('div')
  secondChild.style.margin = '5px'
  secondChild.style.width = '18px'
  secondChild.style.height = '18px'
  secondChild.style.backgroundImage = 'url(https://maps.gstatic.com/tactile/mylocation/mylocation-sprite-1x.png)'
  secondChild.style.backgroundSize = '180px 18px'
  secondChild.style.backgroundPosition = '0px 0px'
  secondChild.style.backgroundRepeat = 'no-repeat'
  secondChild.id = 'you_location_img'
  firstChild.appendChild secondChild
  google.maps.event.addListener map, 'dragend', ->
    $('#you_location_img').css 'background-position', '0px 0px'
    return
  firstChild.addEventListener 'click', ->
    imgX = '0'
    animationInterval = setInterval((->
      if imgX == '-18'
        imgX = '0'
      else
        imgX = '-18'
      $('#you_location_img').css 'background-position', imgX + 'px 0px'
      return
    ), 500)
    if navigator.geolocation
      navigator.geolocation.getCurrentPosition (position) ->
        latlng = new (google.maps.LatLng)(position.coords.latitude, position.coords.longitude)
        #marker.setPosition latlng
        map.setCenter latlng
        clearInterval animationInterval
        $('#you_location_img').css 'background-position', '-144px 0px'
        return
    else
      clearInterval animationInterval
      $('#you_location_img').css 'background-position', '0px 0px'
    return
  controlDiv.index = 1
  map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push controlDiv
  return

findEvents = ->
  newEventWindow.close()